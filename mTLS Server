import http.server
import ssl
import socketserver

# --- Configurações do Servidor ---
HOST = "localhost"
PORT = 8080

# --- Arquivos de Certificado ---
# Servidor usa o certificado assinado e sua chave privada
SERVER_CERT = "server_signed.crt" 
SERVER_KEY = "server.key"
# O servidor confia na CA Raiz para validar o certificado do cliente
CLIENT_CA = "ca.crt" 

# Define o manipulador (handler) para todas as requisições HTTP
class SimpleHandler(http.server.BaseHTTPRequestHandler):
    def do_GET(self):
        """Método executado ao receber uma requisição GET."""
        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.end_headers()
        
        # Confirma que a conexão foi estabelecida via mTLS
        response_message = "<h1>Conexão mTLS bem-sucedida!</h1>"
        response_message += "<p>O servidor validou o certificado do cliente.</p>"
        self.wfile.write(bytes(response_message, "utf-8"))

# Configura o Servidor SSL/TLS
def run_server():
    try:
        context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
        
        # Carrega o certificado assinado e a chave privada do servidor.
        context.load_cert_chain(certfile=SERVER_CERT, keyfile=SERVER_KEY)
        
        # PONTO CRÍTICO DO M-TLS: EXIGIR O CERTIFICADO DO CLIENTE
        context.verify_mode = ssl.CERT_REQUIRED
        
        # Define qual certificado o servidor deve confiar (a CA Raiz)
        context.load_verify_locations(cafile=CLIENT_CA)

        with socketserver.TCPServer((HOST, PORT), SimpleHandler) as httpd:
            print(f"Servidor HTTP comum iniciado em https://{HOST}:{PORT}")
            httpd.socket = context.wrap_socket(httpd.socket, server_side=True)
            print(f"Servidor HTTPS/mTLS em execução em https://{HOST}:{PORT} (Aguardando cliente...)")
            
            httpd.serve_forever()
            
    except ssl.SSLError as e:
        print(f"\n[ERRO FATAL NO SERVIDOR] Falha ao carregar certificados ou configurar SSL: {e}")
        print("Verifique se as chaves e certificados estão corretos.")
    except KeyboardInterrupt:
        print("\nServidor encerrado por interrupção do usuário (Ctrl+C).")
    except FileNotFoundError as e:
        print(f"\n[ERRO FATAL NO SERVIDOR] Arquivo não encontrado: {e}")

if __name__ == "__main__":
    run_server()
